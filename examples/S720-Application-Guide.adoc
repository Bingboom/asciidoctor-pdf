= S720 Pin Configuration Guide
Smart Module  

v1.0, 2014-01-01

:description: ç‰ˆæƒæ‰€æœ‰ Â© æ·±åœ³å¸‚æœ‰æ–¹ç§‘æŠ€è‚¡ä»½æœ‰é™å…¬å¸ 2023ã€‚æ·±åœ³å¸‚æœ‰æ–¹ç§‘æŠ€è‚¡ä»½æœ‰é™å…¬å¸ä¿ç•™æ‰€æœ‰æƒåˆ©ã€‚æœªç»æ·±åœ³å¸‚æœ‰æ–¹ç§‘æŠ€è‚¡ä»½æœ‰é™å…¬å¸ä¹¦é¢åŒæ„ï¼Œä»»ä½•å•ä½å’Œä¸ªäººä¸å¾—æ“…è‡ªæ‘˜æŠ„ã€å¤åˆ¶æœ¬æ–‡æ¡£å†…å®¹çš„éƒ¨åˆ†æˆ–å…¨éƒ¨ï¼Œå¹¶ä¸å¾—ä»¥ä»»ä½•å½¢å¼ä¼ æ’­ã€‚

:organization: Neoway Technology
:doctype: book
:preface-title: Preface
// Settings:
:experimental:
:reproducible:
:icons: font
:listing-caption: Listing
:sectnums:
:toc:
:toclevels: 3
:xrefstyle: short
ifdef::backend-pdf[]
:pdf-theme: chronicles
:pdf-themesdir: {docdir}
:title-logo-image: image:back-cover.svg[pdfwidth=4.25in,align=center]
:source-highlighter: rouge
//:rouge-style: github
endif::[]
// URIs:
:url-devoxx: https://devoxx.be
:url-devoxx-top-talks: https://www.youtube.com/watch?v=1OpAgZvYXLQ&list=PLRsbF2sD7JVq7fv1GZGORShSUIae1ZAPy&index=1
:url-stbernardusabt12: http://www.sintbernardus.be/stbernardusabt12.php?l=en
:url-wolpertinger: http://en.wikipedia.org/wiki/Wolpertinger

[%notitle]
--
[abstract]
{description}
--

== æ¦‚è¿°

S720æ˜¯ä¸€æ¬¾åŸºäºç´«å…‰å±•é”å¹³å°çš„LTEæ— çº¿é€šä¿¡æ™ºèƒ½æ¨¡ç»„ï¼Œæ”¯æŒåˆ¶å¼åŒ…å«FDD-LTEã€TDD-LTEã€WCDMAã€GSMå››æ¨¡é€šä¿¡ï¼ŒåŒæ—¶æ”¯æŒGNSSã€Bluetooth4.2ã€Wi-Fi2.4Gã€‚æ”¯æŒæ˜¾ç¤ºå±ã€æ‘„åƒå¤´ã€SDã€MICã€Speakerã€è€³æœºã€USB2.0ç­‰ã€‚ S720æ”¯æŒAndroid10ç³»ç»Ÿï¼Œé€‚ç”¨äºæ™ºèƒ½POSã€æ™ºèƒ½ç½‘å…³ã€è§†é¢‘ç›‘æ§ã€è¡Œè½¦è®°å½•ä»ªã€DVRã€è½¦è½½æ”¯ä»˜è®¾å¤‡ã€æ‰§æ³•è®¾å¤‡ã€æ™ºèƒ½æ‰‹æŒè®¾å¤‡ã€æ™ºèƒ½ç©¿æˆ´ã€å”®å–æœºã€ç‰©æµæŸœç­‰ç»ˆç«¯ï¼Œèƒ½å¤Ÿæ»¡è¶³ç”¨æˆ·åœ¨å·¥ä¸šã€è½¦è½½å’Œæ¶ˆè´¹ç±»åº”ç”¨ä¸­å¯¹é«˜é€Ÿç‡å’Œå¤šåª’ä½“åŠŸèƒ½çš„éœ€æ±‚ã€‚

ğŸ‘‰æœ¬æ–‡ä¸»è¦ä»‹ç»å¦‚ä½•å¯¹å„æ¨¡ç»„ç®¡è„šåŠŸèƒ½è¿›è¡Œé…ç½®ã€ä»¥åŠä»‹ç»ç”µæ± æ›²çº¿é…ç½®æ–¹æ³•ã€‚ ğŸ¦„

== æ¨¡ç»„å¼€æœº
.S720_EVB
image::EVK.PNG[Wolpertinger,pdfwidth=50%,link={url-wolpertinger},float=left,role=thumb]

åœ¨æŒ‰é”®ä¸­ï¼ŒPOWER ONæŒ‰é”®ä¸ºå¼€æœº/å…³æœºæŒ‰é”®ï¼ŒS720å¼€å‘å¥—ä»¶ä¸Šç”µåï¼Œé•¿æŒ‰POWER ONé”®çº¦3ç§’å³å¯ä½¿æ¨¡å—å¼€æœºã€‚

== åº”ç”¨é…ç½®

=== é©±åŠ¨æ·»åŠ 

Linuxç³»ç»Ÿä½¿ç”¨defconfigæ–‡ä»¶æ¥é…ç½®é©±åŠ¨ï¼Œæœ¬æ–‡ä»¥adcé©±åŠ¨ä¸ºä¾‹ï¼Œä»‹ç»å¦‚ä½•æ·»åŠ ä¸€ä¸ªæ–°çš„é©±åŠ¨ã€‚

=== ç¼–å†™é©±åŠ¨æ–‡ä»¶

ç¼–å†™ç›¸åº”çš„é©±åŠ¨æ–‡ä»¶ï¼Œå¹¶æ”¾åˆ°å¯¹åº”çš„ç›®å½•ã€‚å¯¹åº”çš„ç›®å½•ä¸€èˆ¬æ ¹æ®é©±åŠ¨çš„ç±»å‹æ¥åŒºåˆ†ï¼Œå°½é‡è·ŸåŒä¸€ç±»çš„é©±åŠ¨æ”¾åˆ°ä¸€èµ·ã€‚

å¦‚éœ€æ–°å¢ä¸€ä¸ªnwy_adcæ–‡ä»¶ï¼Œåˆ™éœ€è¦æ–°å¢å¯¹åº”ç›®å½•source\\kernel\\kernel4.14_sprdroidq\\drivers\\nwy

![1680228982010](image/TEMPLATE/1680228982010.png)

æ·»åŠ æ–‡ä»¶ä¹‹åï¼Œè¿˜éœ€è¦ä¿®æ”¹source\\kernel\\kernel4.14_sprdroidq\\driversä¸‹çš„Kconfigå’ŒMakefile

Kconfigæ–‡ä»¶å¦‚ä¸‹æ‰€ç¤ºï¼š

```sh
source "drivers/trusty/Kconfig"**\=neoway add for adc** **source "drivers/nwy/Kconfig"** endmenu
```

Makefileå¦‚ä¸‹æ‰€ç¤ºï¼š

```sh
obj-\$(CONFIG_PARPORT) += parport/ obj-\$(CONFIG_NVM) += lightnvm/ obj-y += base/ block/ misc/ mfd/ nfc/ **nwy/** obj-\$(CONFIG_LIBNVDIMM) += nvdimm/
```

=== æ·»åŠ å¹¶ä¿®æ”¹ Kconfigæ–‡ä»¶å’ŒMakefileæ–‡ä»¶
.1. æ·»åŠ source\\kernel\\kernel4.14_sprdroidq\\drivers\\nwyç›®å½•çš„ Kconfig å’Œ Makefile æ–‡ä»¶ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š

![1680229095533](image/TEMPLATE/1680229095533.png)

.2. ä¿®æ”¹ Makefile æ–‡ä»¶
æ ¹æ®æ‹¬å·é‡Œé¢çš„å®çš„å€¼å†³å®šæ˜¯ç¼–è¯‘è¿›å†…æ ¸ï¼Œç¼–è¯‘æˆæ¨¡å—ï¼Œè¿˜æ˜¯ä¸å‚ä¸ç¼–è¯‘ã€‚

```sh
obj-\$(CONFIG_NWY_ADC_TEMP) += nwy_adc.o 
```

.3. ä¿®æ”¹ Kconfig æ–‡ä»¶

å¯ä»¥å‚ç…§å·²æœ‰å®çš„æ ¼å¼æ¥æ·»åŠ è‡ªå·±çš„æ§åˆ¶å®ã€‚

**æ³¨æ„**: è¿™ä¸ªé‡Œé¢çš„å®æ¯” makefile é‡Œé¢çš„å°‘äº†ä¸€ä¸ª CONFIG_ï¼Œtristateä»£è¡¨é©±åŠ¨å¯ä»¥é…ç½®ä¸ºyã€mã€nä¸‰ç§ï¼Œåˆ†åˆ«ä»£è¡¨ç¼–è¯‘è¿›kernelï¼Œç¼–è¯‘ä¸ºæ¨¡å—å’Œä¸å‚ä¸ç¼–è¯‘

```sh
config NWY_ADC_TEMP  tristate "ADC read driver"  help  if need adc function, say y. 
```

1. ä¿®æ”¹ config æ–‡ä»¶
   **æ³¨æ„ï¼š** å¯¹äºS720_Lé¡¹ç›®ï¼Œéœ€è¦ä¿®æ”¹source\\kernel\\kernel4.14_sprdroidq\\arch\\arm\\configs\\S720_L_sprd_sharkle_defconfigï¼š æ·»åŠ **CONFIG_NWY_ADC_TEMP=y** |

=== æ£€æŸ¥é…ç½®

æ£€æŸ¥æœ€ç»ˆç¼–è¯‘å‡ºæ¥çš„é…ç½®æ–‡ä»¶

```sh
build-unisoc-wayland\\tmp-unisoc_wayland-glibc\\work\\sl8541e_emmc_marlin2-unisoc-linux-gnueabi\\linux-unisoc-4.14\\4.14-r0\\linux-unisoc-4.14-4.14\\.configï¼Œ
```

ç¡®è®¤æ˜¯å¦åŒ…å«äº†æ·»åŠ çš„ CONFIG é¡¹ã€‚

æŒ‰æœ¬æ–‡æ‰€ç¤ºæ“ä½œï¼Œ.configæ–‡ä»¶ä¸­ä¼šåŒ…å«**CONFIG_NWY_ADC_TEMP=y**

== GPIOé…ç½® (Linux)

=== GPIOä»‹ç»

GPIOæ˜¯é€šç”¨è¾“å…¥è¾“å‡ºç«¯å£çš„ç®€ç§°ï¼Œç®€å•æ¥è¯´å°±æ˜¯å¯æ§åˆ¶çš„å¼•è„šï¼ŒèŠ¯ç‰‡çš„GPIOå¼•è„šä¸å¤–éƒ¨è®¾å¤‡è¿æ¥èµ·æ¥ï¼Œä»è€Œå®ç°ä¸å¤–éƒ¨è®¾å¤‡è¿›è¡Œé€šè®¯ã€æ§åˆ¶ä»¥åŠæ•°æ®é‡‡é›†çš„åŠŸèƒ½ã€‚

=== Pinmapé…ç½®

åœ¨é…ç½®pinmapä¹‹å‰é¦–å…ˆè¦é€šè¿‡åŸç†å›¾ç¡®è®¤æ¨¡å—PINè„šå¯¹åº”çš„GPIOåºå·ï¼Œæœ¬æ–‡ä»¥æ¨¡å—çš„PIN90è„šä¸ºä¾‹ï¼Œå¦‚å›¾ï¼Œå¯¹åº”çš„gpioä¸ºgpio89ã€‚

![1680230840150](image/TEMPLATE/1680230840150.png)

å¦‚æœè¦å°†è¯¥ç®¡è„šé…ç½®æˆGPIOåŠŸèƒ½ï¼Œé¦–å…ˆè¦æŸ¥æ‰¾æ‰‹å†Œã€ŠS720-ç®¡è„šå®šä¹‰æ–‡æ¡£-V1.1.xlsxã€‹ã€‚

![1680230855097](image/TEMPLATE/1680230855097.png)

ç”±å›¾ä¸­å¯ä»¥çœ‹å‡ºï¼Œgpio89å¯¹åº”çš„Pin Nameæ˜¯RTCK_LTEï¼Œå¯ä»¥ç”¨ä½œ4ç§åŠŸèƒ½ï¼ŒFunction 3ä¸ºgpioåŠŸèƒ½ï¼Œæˆ‘ä»¬è¦ä½¿ç”¨çš„æ˜¯gpioåŠŸèƒ½ï¼Œåœ¨pinmapæ–‡ä»¶ä¸­æ ¹æ®Pin Nameæ‰¾åˆ°å¯¹åº”çš„é…ç½®é¡¹è¿›è¡Œä¿®æ”¹å³å¯ã€‚

Pinmapæ–‡ä»¶ä½äºbspboot15_sprdroidq720_L-sl8541e_1h10_32b.c

```sh
{REG_PIN_RTCK_LTE,                      BITS_PIN_AF(3)},
{REG_MISC_PIN_RTCK_LTE,                 BITS_PIN_DS(1)|BIT_PIN_NULL|BIT_PIN_WPD|BIT_PIN_SLP_AP|BIT_PIN_SLP_NUL|BIT_PIN_SLP_OE},
```

å¦‚ä¸Šæ‰€ç¤ºï¼Œæ‰¾åˆ°RTCK_LTEä¹‹åï¼Œå°†BITS_PIN_AFé…ç½®ä¸º3ï¼Œæ­¤æ—¶pinè„šå°±å¯ä»¥å½“ä½œæ™®é€šGPIOåŠŸèƒ½ä½¿ç”¨ã€‚æ³¨æ„ï¼šBITS_PIN_AFé…ç½®å€¼ä¸º0-3ï¼Œåˆ†åˆ«å¯¹åº”pinçš„Function 0-3ã€‚

dtsé…ç½®å¦‚ä¸‹æ‰€ç¤ºï¼š

```sh
extcon_gpio: extcon-gpio {
    compatible = "linux,extcon-usb-gpio";
    vbus-gpio = <&pmic_eic 0 GPIO_ACTIVE_HIGH>;
    id-gpio = <&ap_gpio 126 0>;
    otg5v-gpio = <&ap_gpio 89 0>;
};
```

== I2Cé…ç½®

=== I2Cä»‹ç»

I2C é€šè®¯åè®®(Interï¼Integrated Circuit)æ˜¯ç”± Phiilps å…¬å¸å¼€å‘çš„ï¼Œç”±äºå®ƒå¼•è„šå°‘ï¼Œç¡¬ä»¶å®ç°ç®€å•ï¼Œå¯æ‰©å±•æ€§å¼ºï¼Œä¸éœ€è¦ USARTã€CAN ç­‰é€šè®¯åè®®çš„å¤–éƒ¨æ”¶å‘è®¾å¤‡ï¼Œç°åœ¨è¢«å¹¿æ³›åœ°ä½¿ç”¨åœ¨ç³»ç»Ÿå†…å¤šä¸ªé›†æˆç”µè·¯(IC)é—´çš„é€šè®¯ã€‚

S720_Lé¡¹ç›®å¯ä¾›å®¢æˆ·è‡ªç”±ä½¿ç”¨çš„I2Cæœ‰3ç»„ï¼ši2c2ã€i2c3ã€i2c4ã€‚

| i2cç¼–å· | æ¨¡å—pin          | gpioç¼–å·         | å¤‡æ³¨               |
| ------- | ---------------- | ---------------- | ------------------ |
| I2c-2   | pin-91ã€pin-92   | gpio127ã€gpio128 | é»˜è®¤Sensor I2Cä½¿ç”¨ |
| I2c-3   | pin-47ã€pin-48   | gpio146ã€gpio147 | é»˜è®¤è§¦æ‘¸å±I2Cä½¿ç”¨  |
| I2c-4   | pin-168ã€pin-167 | gpio154ã€gpio155 | é»˜è®¤SIM2åŠŸèƒ½       |

å¯¹äºI2Cçš„é…ç½®ï¼Œéœ€è¦åœ¨pinmapå’Œè®¾å¤‡æ ‘ä¸­é…ç½®ï¼Œå…·ä½“é…ç½®æ–¹æ³•è¯·å‚è€ƒä¸‹é¢æ­¥éª¤ã€‚

=== Pinmap é…ç½®

S720_Lé‡‡ç”¨pinmapé…ç½®ç®¡è„šåŠŸèƒ½ï¼Œå¦‚æœä½¿ç”¨I2CåŠŸèƒ½éœ€è¦å¯¹ç…§ä¸‹è¡¨ï¼Œå°†å¯¹åº”piné…ç½®ä¸ºI2CåŠŸèƒ½ã€‚ pinmap æ–‡ä»¶è·¯å¾„ï¼š

```
source\bsp\u-boot15_sprdroidq\board\spreadtrum\S720_L\pinmap-sl8541e_1h10_32b.c
```

![1680233364151](image/TEMPLATE/1680233364151.png)

=== DTS é…ç½®

.1. ç¡®è®¤ aliases èŠ‚ç‚¹
   è¯·åœ¨aliasesèŠ‚ç‚¹ä¸‹æ·»åŠ å¯¹äºi2cèŠ‚ç‚¹çš„é…ç½®ï¼Œå¦‚ä¸‹ä»¥i2c3ä¸ºä¾‹ï¼š é…ç½®è·¯å¾„ï¼š

```sh
source\kernel\kernel4.14_sprdroidq\arch\arm\boot\dts\S720_L_sharkle.dtsi
```

.2. æ·»åŠ å¦‚ä¸‹ä»£ç 

```sh
aliases {
        ...
+ i2c3 = &i2c3;
  ...
  };
```

.3. ç¡®è®¤ I2C èŠ‚ç‚¹

åœ¨socèŠ‚ç‚¹ä¸‹æ·»åŠ I2Cé…ç½®ï¼Œä»¥i2c3 ä¸ºä¾‹ï¼š ä½ç½®ï¼š source_sprdroidq720_L_sharkle.dtsi ä¸€èˆ¬æƒ…å†µä¸‹ï¼ŒI2Cçš„èŠ‚ç‚¹éƒ½æ˜¯é…ç½®å®Œæˆçš„ï¼Œè¿™é‡Œåªéœ€è¦æ£€æŸ¥ç¡®è®¤å³å¯ã€‚

```
i2c3: i2c@70800000 {
    compatible = "sprd,sharkl3-i2c";
    reg = <0x70800000 0x1000>; /*i2cå¯„å­˜å™¨åœ°å€*/
    interrupts = <GIC_SPI 14 IRQ_TYPE_LEVEL_HIGH>;
    clock-names = "enable","i2c", "source"; /*i2cæ—¶é’Ÿé…ç½®*/
    clock-frequency = <400000>; /*i2cä¸»æ¨¡å¼æ—¶é’Ÿé¢‘ç‡*/
    =address-cells = <1>;
    =size-cells = <0>;
    status = "disabled"; /*æ³¨æ„åœ¨ä½¿ç”¨ä¸­éœ€è¦ä½¿èƒ½ï¼šokay*/
};
```

.4. æ·»åŠ  I2C è®¾å¤‡èŠ‚ç‚¹
   i2cèŠ‚ç‚¹é…ç½®è¿‡åï¼Œéœ€è¦æ·»åŠ å¯¹åº”çš„i2cè®¾å¤‡èŠ‚ç‚¹ï¼Œä»¥è§¦æ‘¸å±èŠ‚ç‚¹ä¸¾ä¾‹ã€‚ æ‰“å¼€æ–‡ä»¶ï¼š source_sprdroidq720_L_sl8541e-1h10-gofu.dts é…ç½®å¦‚ä¸‹ä»£ç ï¼š

```
&i2c3 {
    status = "okay"; /*æ‰“å¼€i2cä½¿èƒ½ï¼šokay*/
    goodix@14 {
        compatible = "goodix,gt1x";
        reg = <0x14>; /*ä»æœº7ä½åœ°å€*/
        goodix,irq-gpio = <&ap_gpio 144 GPIO_ACTIVE_HIGH>;
        goodix,reset-gpio = <&ap_gpio 145 GPIO_ACTIVE_HIGH>;
    };
};
```

=== å„è·¯I2C é…ç½®

==== I2C-2 é…ç½®

1. é…ç½®pinmapï¼šæŸ¥çœ‹åŠŸèƒ½è¡¨ï¼ŒåŠŸèƒ½0æ˜¯i2c-2åŠŸèƒ½ã€‚ æ‰“å¼€æ–‡ä»¶ï¼š

```
   source\bsp\u-boot15_sprdroidq\board\spreadtrum\S720_L\pinmap-sl8541e_1h10_32b.c
```

é…ç½®å¦‚ä¸‹ä»£ç ï¼š

```
// i2c-2, scl
{REG_PIN_SCL2,       BITS_PIN_AF(0)},
{REG_MISC_PIN_SCL2,
BITS_PIN_DS(1)|BIT_PIN_WPUS|BIT_PIN_WPU|BIT_PIN_SLP_CM4|BIT_PIN_SLP_WPU|BIT_PIN_SLP_Z},
// i2c-2, sda
{REG_PIN_SDA2,       BITS_PIN_AF(0)},
{REG_MISC_PIN_SDA2,
BITS_PIN_DS(1)|BIT_PIN_WPUS|BIT_PIN_WPU|BIT_PIN_SLP_CM4|BIT_PIN_SLP_WPU|BIT_PIN_SLP_Z},
```

**æ³¨æ„ï¼š** BITS_PIN_AFé…ç½®å€¼ä¸º0-3ï¼Œåˆ†åˆ«å¯¹åº”pinçš„Function 1-4ã€‚

1. ç¡®è®¤aliasesèŠ‚ç‚¹ æ‰“å¼€æ–‡ä»¶ï¼š

```sh
source\kernel\kernel4.14_sprdroidq\arch\arm\boot\dts\S720_L_sharkle.dtsi
```

ç¡®è®¤å¦‚ä¸‹ä»£ç ï¼š

```sh
aliases {
...
    i2c2 = &i2c2;
...
};
```

```sh
i2c2: i2c@70700000 {
            compatible = "sprd,sharkle-i2c";
            reg = <0x70700000 0x100>;
            interrupts = <GIC_SPI 13 IRQ_TYPE_LEVEL_HIGH>;
            clock-frequency = <100000>;
            #address-cells = <1>;
            #size-cells = <0>;
            status = "disabled";
    };
```

==== I2C-3 é…ç½®

1. é…ç½®pinmapï¼šæŸ¥çœ‹åŠŸèƒ½è¡¨ï¼ŒåŠŸèƒ½0æ˜¯I2C-3ã€‚ æ‰“å¼€æ–‡ä»¶ï¼š

```
source\bsp\u-boot15_sprdroidq\board\spreadtrum\S720_L\pinmap-sl8541e_1h10_32b.c
```

é…ç½®å¦‚ä¸‹ä»£ç ï¼š

```
// i2c-3, scl
{REG_PIN_SCL3,       BITS_PIN_AF(0)},
{REG_MISC_PIN_SCL3,
BITS_PIN_DS(3)|BIT_PIN_WPUS|BIT_PIN_WPU|BIT_PIN_SLP_AP|BIT_PIN_SLP_WPU|BIT_PIN_SLP_Z},
// i2c-3, sda
{REG_PIN_SDA3,       BITS_PIN_AF(0)},
{REG_MISC_PIN_SDA3,
BITS_PIN_DS(3)|BIT_PIN_WPUS|BIT_PIN_WPU|BIT_PIN_SLP_AP|BIT_PIN_SLP_WPU|BIT_PIN_SLP_Z},
```

1. ç¡®è®¤aliasesèŠ‚ç‚¹ï¼š æ‰“å¼€æ–‡ä»¶ï¼š
```
   source\kernel\kernel4.14_sprdroidq\arch\arm\boot\dts\S720_L_sharkle.dtsi
```
ç¡®è®¤å¦‚ä¸‹ä»£ç ï¼š
```sh
    aliases {
...
        i2c3 = &i2c3;
...
    };
```
```sh
    i2c3: i2c@70800000 {
                compatible = "sprd,sharkle-i2c";
                reg = <0x70800000 0x100>;
                interrupts = <GIC_SPI 14 IRQ_TYPE_LEVEL_HIGH>;
                clock-frequency = <400000>;
                #address-cells = <1>;
                #size-cells = <0>;
                status = "disabled";
            };

```
==== I2C-4 é…ç½®

1. é…ç½®pinmapï¼šæŸ¥çœ‹åŠŸèƒ½è¡¨ï¼ŒåŠŸèƒ½1æ˜¯I2C-4ã€‚ æ‰“å¼€æ–‡ä»¶ï¼š
```
   source\bsp\u-boot15_sprdroidq\board\spreadtrum\S720_L\pinmap-sl8541e_1h10_32b.c
```
é…ç½®å¦‚ä¸‹ä»£ç ï¼š
```
// I2C-4, scl
{REG_PIN_SIMCLK2,       BITS_PIN_AF(1)},
{REG_MISC_PIN_SIMCLK2,
BITS_PIN_DS(1)|BIT_PIN_WPUS|BIT_PIN_WPU|BIT_PIN_SLP_AP|BIT_PIN_SLP_WPU|BIT_PIN_SLP_Z},
// I2C-4, sda
{REG_PIN_SIMDAT2,        BITS_PIN_AF(1)},
{REG_MISC_PIN_SIMDAT2,
BITS_PIN_DS(1)|BIT_PIN_WPUS|BIT_PIN_WPU|BIT_PIN_SLP_AP|BIT_PIN_SLP_WPU|BIT_PIN_SLP_Z},
```

.1. ç¡®è®¤aliasesèŠ‚ç‚¹ï¼š
æ‰“å¼€æ–‡ä»¶ï¼š
```
  source\kernel\kernel4.14_sprdroidq\arch\arm\boot\dts\S720_L_sharkle.dtsi
```

ç¡®è®¤å¦‚ä¸‹ä»£ç ï¼š

```sh
aliases {
...
    i2c4 = &i2c4;
...
    };
```

```sh
i2c4: i2c@70900000 {
      compatible = "sprd,sharkle-i2c";
      reg = <0x70900000 0x100>;
      interrupts = <GIC_SPI 15 IRQ_TYPE_LEVEL_HIGH>;
      clock-frequency = <100000>;
      #address-cells = <1>;
      #size-cells = <0>;
      status = "disabled";
      };
```

== SPIé…ç½®

=== SPIä»‹ç»

SPIæ˜¯ä¸²è¡Œå¤–è®¾æ¥å£(Serial Peripheral Interface)çš„ç¼©å†™ã€‚æ˜¯ Motorola å…¬å¸æ¨å‡ºçš„ä¸€
ç§åŒæ­¥ä¸²è¡Œæ¥å£æŠ€æœ¯ï¼Œæ˜¯ä¸€ç§é«˜é€Ÿçš„ï¼Œå…¨åŒå·¥ï¼ŒåŒæ­¥çš„é€šä¿¡æ€»çº¿ã€‚

S720_Lé¡¹ç›®å¯ä¾›å®¢æˆ·è‡ªç”±ä½¿ç”¨çš„SPIæœ‰2ç»„ï¼ŒSPI0ã€SPI2ã€‚
[cols=4,frame=ends,grid=rows]
|===
|i2cç¼–å·|æ¨¡ç»„pin|	gpioç¼–å·|	å¤‡æ³¨
|I2c-2|pin-91ã€pin-92|gpio127ã€gpio128|é»˜è®¤Sensor I2Cä½¿ç”¨
|I2c-3|pin-47ã€pin-48|gpio146ã€gpio147|é»˜è®¤è§¦æ‘¸å±I2Cä½¿ç”¨
|I2c-4|pin-168ã€pin-167|gpio154ã€gpio155|é»˜è®¤SIM2åŠŸèƒ½
|===

å¯¹äºSPIçš„é…ç½®ï¼Œå¼•è„šåŠŸèƒ½é…ç½®åœ¨pinmapæ–‡ä»¶ä¸­ï¼ŒspièŠ‚ç‚¹å’Œè®¾å¤‡èŠ‚ç‚¹æ”¾åœ¨Kernelçš„dtsä¸­é…ç½®ï¼Œå…·ä½“é…ç½®æ–¹æ³•è¯·å‚ç…§å¦‚ä¸‹æ­¥éª¤ã€‚

=== Pinmap é…ç½®

S720_Lé‡‡ç”¨pinmapé…ç½®ç®¡è„šåŠŸèƒ½ã€‚å¦‚æœä½¿ç”¨SPIåŠŸèƒ½éœ€è¦å¯¹ç…§ä¸‹è¡¨ï¼Œå°†å¯¹åº”piné…ç½®ä¸ºSPIåŠŸèƒ½ã€‚

pinmap æ–‡ä»¶è·¯å¾„ï¼š

```sh
source\\bsp\\u-boot15_sprdroidq\\board\\spreadtrum\\S720_L\\pinmap-sl8541e_1h10_32b.c
```

![1680231359205](image/TEMPLATE/1680231359205.png)

ä»¥spi0åŠè®¾ å¤‡èŠ‚ç‚¹çš„é…ç½®æ–¹æ³•ä¸¾ä¾‹å¦‚ä¸‹ã€‚

=== DTS é…ç½®

ä¿®æ”¹ pinmap é…ç½®

ä¸¾ä¾‹ï¼Œé…ç½®spi0çš„ä¿®æ”¹ï¼š

[,shell]
----
// spi0, cs
{REG_PIN_SPI0_CSN,       BITS_PIN_AF(0)},
{REG_MISC_PIN_SPI0_CSN,
BITS_PIN_DS(1)|BIT_PIN_NULL|BIT_PIN_WPU|BIT_PIN_SLP_AP|BIT_PIN_SLP_NUL|BIT_PIN_SLP_OE},
// spi0, DO
{REG_PIN_SPI0_DO,        BITS_PIN_AF(0)},
{REG_MISC_PIN_SPI0_DO,
BITS_PIN_DS(1)|BIT_PIN_NULL|BIT_PIN_WPD|BIT_PIN_SLP_AP|BIT_PIN_SLP_WPD|BIT_PIN_SLP_Z},
// spi0, DI
{REG_PIN_SPI0_DI,        BITS_PIN_AF(0)},
{REG_MISC_PIN_SPI0_DI,
BITS_PIN_DS(1)|BIT_PIN_NULL|BIT_PIN_WPD|BIT_PIN_SLP_AP|BIT_PIN_SLP_WPD|BIT_PIN_SLP_Z},
// spi0, CLK
{REG_PIN_SPI0_CLK,       BITS_PIN_AF(0)},
{REG_MISC_PIN_SPI0_CLK,
BITS_PIN_DS(1)|BIT_PIN_NULL|BIT_PIN_WPD|BIT_PIN_SLP_AP|BIT_PIN_SLP_WPD|BIT_PIN_SLP_Z},
----

ç¡®è®¤ aliases èŠ‚ç‚¹

è¯·åœ¨aliasesèŠ‚ç‚¹ä¸‹æ·»åŠ å¯¹äºSPIèŠ‚ç‚¹çš„é…ç½®ï¼Œå¦‚ä¸‹ä»¥spi0ä¸ºä¾‹ï¼š

æ‰“å¼€æ–‡ä»¶ï¼š

```
source\\kernel\\kernel4.14_sprdroidq\\arch\\arm\\boot\\dts\\S720_L_sharkle.dtsi
```

ç¡®è®¤ä»¥ä¸‹ä»£ç ï¼š

```sh
aliases {
...
spi0 = \&spi0;
...
};
```

ç¡®è®¤ SPI èŠ‚ç‚¹

åœ¨socèŠ‚ç‚¹ä¸‹æ·»åŠ SPIé…ç½®ï¼Œä»¥SPI0 ä¸ºä¾‹ï¼š

æ‰“å¼€æ–‡ä»¶ï¼š

```sh
source\\kernel\\kernel4.14_sprdroidq\\arch\\arm\\boot\\dts\\S720_L_sharkle.dtsi
```

å¹¶ç¡®è®¤ä»¥ä¸‹ä»£ç ï¼š

```sh
spi0: spi@70a00000 {
		compatible = "sprd,sc9860-spi",
			"sprd,sharkle-spi";
		reg = <0x70a00000 0x1000>;
		interrupts = <GIC_SPI 7 IRQ_TYPE_LEVEL_HIGH>;
		#address-cells = <1>;
		#size-cells = <0>;
		status = "disabled"; /*åœ¨ä½¿ç”¨è¿‡ç¨‹ä¸­è¯·ä½¿èƒ½èŠ‚ç‚¹ï¼šokay*/
		};
```

ä¸€èˆ¬æƒ…å†µä¸‹SPIçš„èŠ‚ç‚¹éƒ½æ˜¯é…ç½®å®Œæˆçš„ï¼Œè¿™é‡Œåªéœ€è¦æ£€æŸ¥ç¡®è®¤å³å¯ã€‚

æ·»åŠ  SPI è®¾å¤‡èŠ‚ç‚¹

SPIèŠ‚ç‚¹é…ç½®è¿‡åï¼Œéœ€è¦æ·»åŠ å¯¹åº”çš„SPIè®¾å¤‡èŠ‚ç‚¹ï¼Œä»¥fpgaèŠ‚ç‚¹ä¸¾ä¾‹ã€‚

æ‰“å¼€æ–‡ä»¶ï¼š

```sh
source\\kernel\\kernel4.14_sprdroidq\\arch\\arm\\boot\\dts\\S720_L_sl8541e-1h10-gofu.dts
```

å‚è€ƒé…ç½®ä»¥ä¸‹ä»£ç ï¼š

```sh
&spi0 {
	status = "okay"; /*æ‰“å¼€spiä½¿èƒ½ï¼šokay*/
	fpga: fpga {
		compatible = "lattice-spi";
		spi-max-frequency = <48000000>; /*spiæ—¶é’Ÿé¢‘ç‡*/
		crstn-gpio = <&ap_gpio 133 0>;
		rstn-gpio = <&ap_gpio 132 0>;
		reg = <0>;
	};
};
```

=== å„è·¯SPI é…ç½®

==== SPI-0 é…ç½®

1. é…ç½®pinmapï¼šæŸ¥çœ‹åŠŸèƒ½è¡¨ï¼ŒåŠŸèƒ½0æ˜¯SPI-0åŠŸèƒ½ã€‚

æ‰“å¼€æ–‡ä»¶ï¼š

```sh
source\\bsp\\u-boot15_sprdroidq\\board\\spreadtrum\\S720_L\\pinmap-sl8541e_1h10_32b.c
```

é…ç½®ä»¥ä¸‹ä»£ç ï¼š

```sh
// spi0 cs
{REG_PIN_SPI0_CSN,       BITS_PIN_AF(0)},
{REG_MISC_PIN_SPI0_CSN,
BITS_PIN_DS(1)|BIT_PIN_NULL|BIT_PIN_WPU|BIT_PIN_SLP_AP|BIT_PIN_SLP_NUL|BIT_PIN_SLP_OE},
// spi0 DO
{REG_PIN_SPI0_DO,        BITS_PIN_AF(0)},
{REG_MISC_PIN_SPI0_DO,
BITS_PIN_DS(1)|BIT_PIN_NULL|BIT_PIN_WPD|BIT_PIN_SLP_AP|BIT_PIN_SLP_WPD|BIT_PIN_SLP_Z},
// spi0 DI
{REG_PIN_SPI0_DI,        BITS_PIN_AF(0)},
{REG_MISC_PIN_SPI0_DI,
BITS_PIN_DS(1)|BIT_PIN_NULL|BIT_PIN_WPD|BIT_PIN_SLP_AP|BIT_PIN_SLP_WPD|BIT_PIN_SLP_Z},
// spi0 CLK
{REG_PIN_SPI0_CLK,       BITS_PIN_AF(0)},
{REG_MISC_PIN_SPI0_CLK,
BITS_PIN_DS(1)|BIT_PIN_NULL|BIT_PIN_WPD|BIT_PIN_SLP_AP|BIT_PIN_SLP_WPD|BIT_PIN_SLP_Z},
```

1. ç¡®è®¤aliasesèŠ‚ç‚¹

æ‰“å¼€æ–‡ä»¶ï¼š

```sh
source\\kernel\\kernel4.14_sprdroidq\\arch\\arm\\boot\\dts\\S720_L_sharkle.dtsi
```

ç¡®è®¤ä»¥ä¸‹ä»£ç ï¼š

```sh
aliases {
...
spi0 = \&spi0;
...
};
```

```sh
spi0: spi@70a00000 {
		compatible = "sprd,sc9860-spi",
			"sprd,sharkle-spi";
		reg = <0x70a00000 0x1000>;
		interrupts = <GIC_SPI 7 IRQ_TYPE_LEVEL_HIGH>;
		#address-cells = <1>;
		#size-cells = <0>;
		status = "disabled";
	};
```

==== SPI-2 é…ç½®

1. é…ç½®pinmapï¼šæŸ¥çœ‹åŠŸèƒ½è¡¨ï¼ŒåŠŸèƒ½0æ˜¯SPI-2ã€‚

æ‰“å¼€æ–‡ä»¶ï¼š

```sh
source\\bsp\\u-boot15_sprdroidq\\board\\spreadtrum\\S720_L\\pinmap-sl8541e_1h10_32b.c
```

é…ç½®ä»¥ä¸‹ä»£ç ï¼š

```sh
{REG_PIN_SPI2_CSN,                      BITS_PIN_AF(0)},
{REG_MISC_PIN_SPI2_CSN,                 BITS_PIN_DS(1)|BIT_PIN_NULL|BIT_PIN_WPU|BIT_PIN_SLP_AP|BIT_PIN_SLP_NUL|BIT_PIN_SLP_OE},
{REG_PIN_SPI2_DO,                       BITS_PIN_AF(0)},
BITS_PIN_DS(1)|BIT_PIN_NULL|BIT_PIN_WPD|BIT_PIN_SLP_AP|BIT_PIN_SLP_WPD|BIT_PIN_SLP_Z},
{REG_PIN_SPI2_DI,                       BITS_PIN_AF(0)},
{REG_MISC_PIN_SPI2_DI,                  BITS_PIN_DS(1)|BIT_PIN_NULL|BIT_PIN_WPD|BIT_PIN_SLP_AP|BIT_PIN_SLP_WPD|BIT_PIN_SLP_Z},
{REG_PIN_SPI2_CLK,                      BITS_PIN_AF(0)},
{REG_MISC_PIN_SPI2_CLK,                 BITS_PIN_DS(1)|BIT_PIN_NULL|BIT_PIN_WPD|BIT_PIN_SLP_AP|BIT_PIN_SLP_WPD|BIT_PIN_SLP_Z},
```

1. ç¡®è®¤aliasesèŠ‚ç‚¹ï¼š

æ‰“å¼€æ–‡ä»¶ï¼š

```sh
source\\kernel\\kernel4.14_sprdroidq\\arch\\arm\\boot\\dts\\S720_L_sharkle.dtsi
```

ç¡®è®¤ä»¥ä¸‹ä»£ç ï¼š

```sh
aliases {
...
spi2 = \&spi2;
...
};
```

```sh
spi2: spi@70c00000 {
		compatible = "sprd,sc9860-spi",
			"sprd,sharkle-spi";
		reg = <0x70c00000 0x1000>;
		interrupts = <GIC_SPI 9 IRQ_TYPE_LEVEL_HIGH>;
		#address-cells = <1>;
		#size-cells = <0>;
		status = "disabled";
	        };
```

== UARTé…ç½®
=== UARTä»‹ç»

é€šç”¨å¼‚æ­¥æ”¶å‘ä¼ è¾“å™¨ï¼ˆUniversal Asynchronous Receiver/Transmitter)ï¼Œé€šå¸¸ç§°ä½œUARTã€‚å®ƒå°†è¦ä¼ è¾“çš„èµ„æ–™åœ¨ä¸²è¡Œé€šä¿¡å’Œå¹¶è¡Œé€šä¿¡ä¹‹é—´åŠ ä»¥è½¬æ¢ã€‚ä½œä¸ºæŠŠå¹¶è¡Œè¾“å…¥ä¿¡å·è½¬æˆä¸²è¡Œè¾“å‡ºä¿¡å·çš„èŠ¯ç‰‡ï¼ŒUARTé€šå¸¸è¢«é›†æˆäºå…¶ä»–é€šè®¯æ¥å£çš„è¿ç»“ä¸Šã€‚

=== UARTä½¿ç”¨æƒ…å†µ

å½“å‰å¹³å°å¼•å‡ºçš„uartç®¡è„šåˆ†ä¸ºä¸‰ç»„ï¼š

- DBG_TXD/ DBG_RXDï¼Œå¯¹åº”pin93å’Œpin94ï¼Œ
- UART0_TXD/ UART0_RXDï¼Œå¯¹åº”pin34å’Œpin35ï¼Œ
- UART2_RXD/ UART2_TXDï¼Œå¯¹åº”pin153å’Œpin154ã€‚

ç”±äºèŠ¯ç‰‡å†…éƒ¨åªæœ‰ä¸¤ä¸ªUARTæ§åˆ¶å™¨ï¼šAP UARTæ§åˆ¶å™¨å’ŒCM4 UARTæ§åˆ¶å™¨ï¼Œæ‰€ä»¥åŒæ—¶åªèƒ½æœ‰ä¸¤ç»„UARTèµ·å·¥ä½œã€‚

é»˜è®¤ä½¿ç”¨DBG_TXD/ DBG_RXDå’ŒUART2_RXD/ UART2_TXDï¼Œç®¡è„šDBG_TXD/ DBG_RXDè¿æ¥åˆ°AP UARTæ§åˆ¶å™¨ï¼Œç®¡è„šUART2_RXD/ UART2_TXDè¿æ¥åˆ°CM4 UARTæ§åˆ¶å™¨ã€‚

=== AP UARTæ§åˆ¶å™¨é…ç½®

==== pinmapé…ç½®

å¦‚å›¾ï¼Œæœ¬é…ç½®éœ€è¦ä½¿ç”¨æ¨¡ç»„çš„Pin93å’ŒPin94å¼•è„šï¼š

![1680231572155](image/TEMPLATE/1680231572155.png)

æ ¹æ®æ‰‹å†Œã€ŠS720-ç®¡è„šå®šä¹‰æ–‡æ¡£-V1.1ã€‹æ‰¾åˆ°å®ƒä»¬å¯¹åº”çš„GPIOç®¡è„šï¼š

![1680231578951](image/TEMPLATE/1680231578951.png)

å¦‚ä¸Šå›¾æ‰€ç¤ºï¼ŒPIN93å’ŒPIN94è„šå¯¹åº”çš„GPIOæ˜¯GPIO70å’ŒGPIO71ã€‚

åœ¨pinmapæ–‡ä»¶ä¸­æ ¹æ®èŠ¯ç‰‡ç®¡è„šåç§°æ‰¾åˆ°å¯¹åº”çš„é…ç½®é¡¹è¿›è¡Œä¿®æ”¹ï¼ŒPinmapæ–‡ä»¶ä½äºï¼š

```sh
source\\bsp\\u-boot15_sprdroidq\\board\\spreadtrum\\S720_L\\pinmap-sl8541e_1h10_32b.c
```

```sh
{REG_PIN_U1TXD,	BITS_PIN_AF(0)},
{REG_MISC_PIN_U1TXD,	BITS_PIN_DS(1)|BIT_PIN_NULL|BIT_PIN_NUL|BIT_PIN_SLP_AP|BIT_PIN_SLP_NUL|BIT_PIN_SLP_OE},//BB_U1TXD
{REG_PIN_U1RXD,	BITS_PIN_AF(0)},
{REG_MISC_PIN_U1RXD,	BITS_PIN_DS(1)|BIT_PIN_NULL|BIT_PIN_WPU|BIT_PIN_SLP_AP|BIT_PIN_SLP_WPU|BIT_PIN_SLP_IE},//BB_U1RXD
```

æ‰¾åˆ°å¯¹åº”çš„é…ç½®ä¹‹åï¼Œå¯¹ç…§æ–‡æ¡£ã€ŠS720-ç®¡è„šå®šä¹‰æ–‡æ¡£-V1.1ã€‹ï¼Œå¯ä»¥çœ‹å‡ºï¼Œfunction 0ä¸ºU1TXD/U1RXDåŠŸèƒ½ï¼Œå°†BITS_PIN_AFé…ç½®ä¸º0ï¼Œæ­¤æ—¶pinè„šå³ä½œä¸ºuartåŠŸèƒ½ä½¿ç”¨ã€‚

==== dtsé…ç½®

pinmapé…ç½®å®Œæˆä¹‹åï¼Œä¸‹ä¸€æ­¥å°±è¦åšdtsé…ç½®ã€‚

1. aliasesæ·»åŠ 
   æ‰“å¼€æ–‡ä»¶

```sh
source\\kernel\\kernel4.14_sprdroidq\\arch\\arm\\boot\\dts\\ S720_L_sl8541e-1h10-gofu.dts
```

```sh
aliases {
	serial0 = &uart0;
	serial1 = &uart1;
};
```

1. æ·»åŠ uarté…ç½®

   æ‰“å¼€æ–‡ä»¶

```sh
source\\kernel\\kernel4.14_sprdroidq\\arch\\arm\\boot\\dts\\S720_L_sharkle.dtsi
```

å¢åŠ uart1é©±åŠ¨é…ç½®ï¼ŒåŒ…æ‹¬regã€interruptã€clockè¿™äº›åŸºæœ¬éƒ½æ˜¯é…ç½®å¥½çš„ï¼Œåœ¨ä½¿ç”¨çš„æ—¶å€™æ‰“å¼€å³å¯ï¼›

```sh
uart1: serial@70100000 {
	compatible = "sprd,sc9836-uart";
	reg = <0x70100000 0x100>;
	interrupts = <GIC_SPI 3 IRQ_TYPE_LEVEL_HIGH>;
	status = "disabled";
			};
```

å½“éœ€è¦ä½¿ç”¨uartèŠ‚ç‚¹çš„æ—¶å€™ï¼Œå°†uarté…ç½®statusè®¾ä¸ºokã€‚

åœ¨é…ç½®å®Œæˆåï¼Œdev/ä¸‹ä¼šç”Ÿæˆä¸€ä¸ªåä¸ºttyS1çš„èŠ‚ç‚¹ï¼Œuartçš„é…ç½®å°±å®Œæˆäº†ã€‚

| ![1680231725485](image/TEMPLATE/1680231725485.png)![](media/d076bb72ac25006862abfe963be2aa5d.png) | è¯¥ä¸²å£é»˜è®¤ç”¨ä½œå†…æ ¸çš„console logæ‰“å°ã€‚ |
| --------------------------------------------------------------------------------------------- | ------------------------------------- |

=== CM4 UARTæ§åˆ¶å™¨é…ç½®

==== pinmapé…ç½®

å¦‚å›¾ï¼Œæˆ‘ä»¬æ‰€è¦ä½¿ç”¨çš„è„šU2TXDG0å’ŒU2TXDG0ï¼›

![1680231793906](image/TEMPLATE/1680231793906.png)

æ ¹æ®æ‰‹å†Œã€ŠS720-ç®¡è„šå®šä¹‰æ–‡æ¡£-V1.1ã€‹ï¼Œå¯¹åº”åœ¨pinmapä¸­æ ¹æ®PinNameæ‰¾åˆ°å¯¹åº”çš„é…ç½®é¡¹è¿›è¡Œä¿®æ”¹ï¼›
![1680231813016](image/TEMPLATE/1680231813016.png)

Pinmapæ–‡ä»¶ä½äº

```sh
source\\bsp\\u-boot15_sprdroidq\\board\\spreadtrum\\S720_L\\pinmap-sl8541e_1h10_32b.c
```

```sh
{REG_PIN_U2TXD,	BITS_PIN_AF(0)},,
{REG_MISC_PIN_U2TXD,	BITS_PIN_DS(1)|BIT_PIN_NULL|BIT_PIN_NUL|BIT_PIN_SLP_AP|BIT_PIN_SLP_NUL|BIT_PIN_SLP_OE},
{REG_PIN_U2RXD,	BITS_PIN_AF(0)},
{REG_MISC_PIN_U2RXD,	BITS_PIN_DS(1)|BIT_PIN_NULL|BIT_PIN_WPU|BIT_PIN_SLP_AP|BIT_PIN_SLP_WPU|BIT_PIN_SLP_IE},
```

æ‰¾åˆ°å¯¹åº”çš„é…ç½®ä¹‹åï¼Œå¯¹ç…§æ–‡æ¡£ã€ŠS720-ç®¡è„šå®šä¹‰æ–‡æ¡£-V1.1ã€‹ï¼Œå¯ä»¥çœ‹å‡ºï¼Œfunction 0ä¸ºU2TXD/U2RXDåŠŸèƒ½ï¼Œå°†BITS_PIN_AFé…ç½®ä¸º0ï¼Œæ­¤æ—¶pinè„šå³ä½œä¸ºuartåŠŸèƒ½ä½¿ç”¨ã€‚

==== dtsé…ç½®

pinmapé…ç½®å®Œæˆä¹‹åï¼Œä¸‹ä¸€æ­¥å°±è¦åšdtsé…ç½®ã€‚

1. aliasesæ·»åŠ 

   æ·»åŠ åœ¨é…ç½®ç›®å½•ä½äºsource\\kernel\\kernel4.14_sprdroidq\\arch\\arm\\boot\\dts\\ S720_L_sl8541e-1h10-gofu.dts

```sh
S720_L_sl8541e-1h10-gofu.dts
aliases {
	serial0 = &uart0; /*è¿™é‡Œå¯¹åº”æ˜¯uartæ§åˆ¶å™¨åå­—*/
	serial1 = &uart1;
};
```

1. æ·»åŠ uarté…ç½®

   ä½äºsource\\kernel\\kernel4.14_sprdroidq\\arch\\arm\\boot\\dts\\S720_L_sharkle.dtsi

å¢åŠ uart0é©±åŠ¨é…ç½®ï¼ŒåŒ…æ‹¬regã€interruptã€clockè¿™äº›åŸºæœ¬éƒ½æ˜¯é…ç½®å¥½çš„ï¼Œåœ¨ä½¿ç”¨çš„æ—¶å€™æ‰“å¼€å³å¯ï¼›

```sh
uart0: serial@508d0000 {
		compatible = "sprd,sc9836-uart-ex";
		reg = <0x508d0000 0x100>;
		interrupts = <GIC_SPI 1 IRQ_TYPE_LEVEL_HIGH>;
		sprd,aon-apb = <&aon_apb_regs>;
		status = "disabled";
			};
```

å½“éœ€è¦ä½¿ç”¨uart0èŠ‚ç‚¹çš„æ—¶å€™ï¼Œå°†uart0é…ç½®statusè®¾ä¸ºokã€‚

åœ¨é…ç½®å®Œæˆåï¼Œdev/ä¸‹ä¼šç”Ÿæˆä¸€ä¸ªåä¸ºttySE0çš„èŠ‚ç‚¹ï¼Œuart0çš„é…ç½®å°±å®Œæˆäº†ã€‚

== ç”µæ± æ›²çº¿é…ç½®

=== ä»‹ç»

ç”µæ± æ˜¯æ™ºèƒ½æ¨¡å—ä¸­é‡è¦çš„ä¾›ç”µéƒ¨ä»¶ï¼Œå…¶å……ç”µæ§åˆ¶å’Œæ”¾ç”µæ—¶çš„ç”µé‡æ˜¾ç¤ºéœ€è¦ä¾èµ–ç”µæ± çš„å……æ”¾ç”µæ›²çº¿æ•°æ®ã€‚

æœ¬æ–‡ä»¥ JBT-D009å‹å·çš„ç”µæ± æ·»åŠ åˆ° S720_L é¡¹ç›®ä¸ºä¾‹ï¼Œä»‹ç»å¦‚ä½•åœ¨ Linux kernel ä¸­æ·»åŠ è‡ªå®šä¹‰çš„ç”µæ± æ›²çº¿æ–‡ä»¶ã€‚

=== è®¾å¤‡æ ‘é…ç½®

å……ç”µèŠ¯ç‰‡å’Œç”µé‡è®¡çš„é…ç½®åœ¨source\\kernel\\kernel4.14_sprdroidq\\arch\\arm\\boot\\dts\\S720_L_sl8541e-1h10-gofu.dtsï¼Œchager-manageré©±åŠ¨ä¸ºç”µæ± è®¡é‡å’Œå……ç”µçš„ä¸­é—´é©±åŠ¨ï¼Œå…·æœ‰ç”µæ± å‚æ•°è·å–ï¼Œå……ç”µå‚æ•°è·å–å’Œä¸ç”¨æˆ·å±‚é€šä¿¡ç­‰åŠŸèƒ½ã€‚

```sh
charger-manager {
		compatible = "charger-manager";
		cm-name = "battery";
		cm-poll-mode = <2>;
		cm-poll-interval = <15000>;
		cm-battery-stat = <2>;

		cm-fullbatt-vchkdrop-ms = <30000>;
		cm-fullbatt-vchkdrop-volt = <60000>;
		cm-fullbatt-voltage = <4300000>;
		cm-fullbatt-current = <120000>;
		cm-fullbatt-capacity = <100>;

		cm-num-chargers = <1>;
		cm-chargers = "sc2721_charger";
		cm-fuel-gauge = "sc27xx-fgu";

		/* in deci centigrade */
		cm-battery-cold = <200>;
		cm-battery-cold-in-minus;
		cm-battery-hot = <800>;
		cm-battery-temp-diff = <100>;
```

å…¶ä¸­ï¼š

- cm-chargers = "sc2721_charger"æ˜¯å……ç”µèŠ¯ç‰‡çš„é…ç½®ï¼Œç¤ºä¾‹ä¸­é…ç½®ä¸ºsc2721_chargerå†…éƒ¨å……ç”µèŠ¯ç‰‡ã€‚
- cm-fuel-gauge = "sc27xx-fgu"æ˜¯ç”µé‡è®¡çš„é…ç½®ï¼Œç¤ºä¾‹ä¸­é…ç½®ä¸ºsc27xx-fguç”µé‡è®¡ã€‚

å¯¹åº”nameé…ç½®ä½äºå¯¹åº”chargerèŠ¯ç‰‡ä¸­ï¼Œæœç´¢sc27xx_fgu_descå…³é”®å­—ï¼š

![1680231895233](image/TEMPLATE/1680231895233.png)

æ— è®ºç”µé‡è®¡çš„è®¡é‡æˆ–å……ç”µéƒ½éœ€è¦ä¾èµ–ç”µæ± å‚æ•°çš„é…ç½®ï¼ŒS720_Lä¸­ç”µé‡è®¡å’Œå……ç”µçš„ç”µæ± é…ç½®å‡ä¸ºmonitored-battery = \<&bat\>ï¼Œä¸å»ºè®®ä¿®æ”¹ã€‚

```sh
&pmic_fgu {
	monitored-battery = <&bat>;
	sprd,calib-resistance-real = <20000>;
	sprd,calib-resistance-spec = <20000>;
};
&pmic_charger {
  status = "okay";
  phys = <&hsphy>;
  monitored-battery = <&bat>;
};
```

=== ç”µæ± æ›²çº¿é…ç½®æ–¹æ³•

åœ¨é…ç½®ç”µæ± å¯¹åº”çš„ç”µæ± ä¹‹å‰ï¼Œä¼šä»ç”µæ± å‚å•†æ‹¿åˆ°ä¸€ç»„ç”µæ± æ›²çº¿å’Œç”µæ± çš„è¯´æ˜æ–‡æ¡£ï¼Œä»¥ã€ŠA.11.002.008.004 JBT-D009ä¸­è‹±æ–‡ç”µæ± è§„æ ¼ä¹¦Bç‰ˆ.pdfã€‹ä¸ºä¾‹ã€‚

ç”µæ± ç»„åŸºæœ¬å‚æ•°

ç”µæ± è§„æ ¼ä¹¦ä¸­ä¸€èˆ¬æä¾›ç”µæ± ç»„åŸºæœ¬å‚æ•°ï¼ŒåŒ…æ‹¬æ ‡å‡†å®¹é‡ã€å……ç”µæˆªè‡³ç”µå‹ã€æœ€å¤§å……ç”µç”µæµã€å·¥ä½œæ¸©åº¦ç­‰å†…å®¹ï¼Œä¸‹å›¾ä¸ºJBT-D009ç¤ºä¾‹ï¼š

![1680231913389](image/TEMPLATE/1680231913389.png)

å›¾ä¸ºS720_Lç”µæ± ç›¸å…³é…ç½® ï¼š

```sh
bat: battery {
		compatible = "simple-battery";
		charge-full-design-microamp-hours = <2780000>;
		charge-term-current-microamp = <120000>;
		constant_charge_voltage_max_microvolt = <4350000>;
		factory-internal-resistance-micro-ohms = <320000>;
		voltage-min-design-microvolt = <3450000>;
		ocv-capacity-celsius = <20>;
		ocv-capacity-table-0 = <4330000 100>, <4249000 95>, <4189000 90>,
					<4133000 85>, <4081000 80>, <4034000 75>,
					<3991000 70>, <3953000 65>, <3910000 60>,
					<3866000 55>, <3836000 50>, <3813000 45>,
					<3795000 40>, <3782000 35>, <3774000 30>,
					<3765000 25>, <3750000 20>, <3726000 15>,
					<3687000 10>, <3658000 5>, <3400000 0>;
		voltage-temp-table = <1095000 800>, <986000 850>, <878000 900>,
				      <775000 950>, <678000 1000>, <590000 1050>,
				      <510000 1100>, <440000 1150>, <378000 1200>,
				      <324000 1250>, <278000 1300>, <238000 1350>,
				      <204000 1400>, <175000 1450>, <150000 1500>,
				      <129000 1550>, <111000 1600>, <96000 1650>;
		charge-sdp-current-microamp = <500000 500000>;
		charge-dcp-current-microamp = <1150000 3000000>;
		charge-cdp-current-microamp = <1150000 1150000>;
		charge-unknown-current-microamp = <500000 500000>;
	};
```

å‚æ•°è¯´æ˜å¦‚ä¸‹ï¼š

- charge-full-design-microamp-hoursï¼šæ ‡å‡†å®¹é‡ uahã€‚
- charge-term-current-microampï¼šæˆªè‡³ç”µæµ uaï¼ˆå¯æ ¹æ®æƒ…å†µé…ç½®ï¼‰ã€‚
- constant_charge_voltage_max_microvoltï¼šæœ€å¤§ç”µå‹ã€‚
- factory-internal-resistance-micro-ohmsï¼šç”µæ± å†…é˜»ã€‚
- voltage-min-design-microvoltï¼šæœ€å°ç”µå‹ï¼Œä¸å»ºè®®ä¿®æ”¹ã€‚
- charge-sdp-current-microampï¼šå……ç”µç±»å‹ä¸ºsdpæ—¶çš„å……ç”µç”µæµï¼Œå›¾ç¤ºä¸º500maâ€”500maã€‚
- charge-dcp-current-microampï¼šå……ç”µç±»å‹ä¸ºdcpæ—¶çš„å……ç”µç”µæµï¼Œå›¾ç¤ºä¸º1150ma-3000maã€‚
- charge-cdp-current-microampï¼šå……ç”µç±»å‹ä¸ºcdpæ—¶çš„å……ç”µç”µæµï¼Œå›¾ç¤ºä¸º1150ma-1150maã€‚
- charge-unknown-current-microampï¼šå……ç”µç±»å‹æœªè¯†åˆ«æ—¶çš„å……ç”µç”µæµï¼Œå›¾ç¤ºä¸º500maã€‚

  ç”µæ± å……ç”µæ›²çº¿é…ç½®

åœ¨é…ç½®ä¹‹å‰ï¼Œä»ç”µæ± å‚ä¼šæ‹¿åˆ°ä¸€ç»„åŸºç¡€ç”µæ± æ•°æ®ï¼Œåˆ†æ¸©åº¦åˆ†ä¸º0Â°ã€-10Â°ã€25Â°ã€50Â°å››ç»„

ocv-capacity-celsiuså’Œocv-capacity-table-0ä¸¤ç»„æ•°æ®æ˜¯ç”µæ± å……ç”µæ›²çº¿çš„é…ç½®æ–‡ä»¶ã€‚

- **ocv-capacity-celsius**ä»£è¡¨é©±åŠ¨éœ€è¦é…ç½®20ç»„å‚æ•°ï¼Œä¸å»ºè®®ä¿®æ”¹ã€‚
- **ocv-capacity-table-0**ä¸ºç”µæ± æ›²çº¿é…ç½®ï¼Œå‚æ•°ä¸­ä»£è¡¨ç”µæ± ç”µå‹å’Œç”µæ± ç”µé‡ï¼Œä¾‹å¦‚ï¼Œ\<3953000 65\>ï¼Œä¸ºç”µæ± ç”µå‹åœ¨3.95væ—¶çš„ç”µæ± ç”µé‡ä¸º65%ï¼›é…ç½®ä¸­ï¼Œä¸€å…±åˆ†ä¸º20æ¡£ï¼ŒS726ä¸­æ ¹æ®ç”µæ± å‚å•†æä¾›çš„ç”µæ± æ›²çº¿è¡¨é…ç½®å³å¯ï¼Œå¯¹åº”çš„æ›²çº¿æ¸©åº¦25Â°ã€‚

```sh
ocv-capacity-table-0 = <4330000 100>, <4249000 95>, <4189000 90>,
					<4133000 85>, <4081000 80>, <4034000 75>,
					<3991000 70>, <3953000 65>, <3910000 60>,
					<3866000 55>, <3836000 50>, <3813000 45>,
					<3795000 40>, <3782000 35>, <3774000 30>,
					<3765000 25>, <3750000 20>, <3726000 15>,
					<3687000 10>, <3658000 5>, <3400000 0>;
```

voltage-temp-tableä¸ºæ¸©åº¦ç”µå‹å¯¹ç…§è¡¨ï¼Œç”¨äºè¯»å–ç”µæ± æ¸©åº¦æ ¹æ®NTCå˜åŒ–ï¼Œç”µæ± æ›²çº¿æ— éœ€è¿›è¡Œä¿®æ”¹ã€‚